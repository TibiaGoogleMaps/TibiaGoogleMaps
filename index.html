<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Tibia Map Editor - GitHub Pro</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        #viewport { width: 100vw; height: 100vh; cursor: grab; position: relative; }
        #world { position: absolute; transform-origin: 0 0; }
        
        .slot { position: absolute; width: 1078px; height: 790px; border: 1px solid #1a1a1a; background: #0a0a0a; display: flex; align-items: center; justify-content: center; }
        .view-mode .slot { border: none; background: transparent; }

        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(11, 1fr);
            pointer-events: none; z-index: 2;
        }
        
        .grid-overlay div { border: 0.5px solid rgba(255, 255, 255, 0.05); } 
        .grid-green .grid-overlay div { border: 0.5px solid rgba(0, 255, 0, 0.4); }
        .grid-red .grid-overlay div { border: 0.5px solid rgba(255, 0, 0, 0.4); }
        .grid-hidden .grid-overlay { display: none; }

        .map-base { width: 100%; height: 100%; position: absolute; z-index: 1; image-rendering: pixelated; pointer-events: none; }
        
        .grid-livre { position: absolute; z-index: 50; image-rendering: pixelated; user-select: none; cursor: move; border: 1px solid transparent; }
        .grid-livre.is-locked { cursor: default; pointer-events: none; }
        .edit-mode-active .grid-livre:hover:not(.is-locked) { border: 1px dashed yellow; }
        
        .entidade-wrap { position: absolute; z-index: 60; }
        .entidade-img { width: 100%; height: 100%; display: block; image-rendering: pixelated; cursor: pointer; }
        
        /* Filtros */
        .hide-npc .type-npc, .hide-item .type-item, .hide-mob .type-mob, .hide-balao .type-balao { display: none !important; }

        /* Pain√©is de Edi√ß√£o (Escondidos por padr√£o) */
        .controles-npc, .ui-top-bar, .controles-texto { display: none; position: absolute; z-index: 110; background: rgba(0,0,0,0.8); padding: 3px; border-radius: 5px; }
        .edit-mode-active .controles-npc, .edit-mode-active .ui-top-bar, .edit-mode-active .controles-texto { display: flex; gap: 4px; }

        .btn-npc { border: none; padding: 4px 6px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 11px; color: #000; background: #eee; }
        .b-del { background: #ff4444; color: #fff; }
        .b-sz { background: #fff; }

        #search-container { position: fixed; top: 15px; right: 15px; width: 250px; z-index: 2000; }
        #map-search { width: 100%; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #444; color: #fff; border-radius: 4px; outline: none; }
        #search-results { background: rgba(20,20,20,0.95); max-height: 200px; overflow-y: auto; }
        
        .interface-container { position: absolute; z-index: 200; pointer-events: auto; }
        .interface-img { width: 100%; height: 100%; display: block; image-rendering: pixelated; pointer-events: none; }
        .ui-texto { color: #fff; font-size: 14px; text-shadow: 1px 1px 0px #000; white-space: pre-wrap; outline: none; width: 100%; height: 100%; }

        .panel { position: fixed; background: rgba(0,0,0,0.9); padding: 12px; border-radius: 8px; border: 1px solid #333; z-index: 1000; }
        .left { top: 15px; left: 15px; width: 220px; }
        .right { top: 50%; right: 20px; transform: translateY(-50%); text-align: center; }
        .btn-ui-main { width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px; }
        
        /* Quando o modo edi√ß√£o est√° OFF, o world n√£o aceita cliques nos itens de edi√ß√£o */
        .edit-mode-off .entidade-img, .edit-mode-off .grid-livre { pointer-events: none; }
    </style>
</head>
<body class="edit-mode-off">

    <div id="search-container">
        <input type="text" id="map-search" placeholder="üîç Buscar Tag..." oninput="buscarTags()">
        <div id="search-results"></div>
    </div>

    <div class="panel left">
        <strong>Tibia Editor Pro</strong><br>
        <small id="status" style="color: #0f0;">Pasta: mapcontainer</small><br><br>
        
        <button class="btn-ui-main" style="background: #222;" onclick="toggleEditMode()" id="btnEdit">Modo Edi√ß√£o: OFF</button>
        <button class="btn-ui-main b-save" onclick="baixarJSON()">üíæ Baixar map_data.json</button>
        
        <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
        <button class="btn-ui-main" onclick="toggleGrid()">Grade: ON/OFF</button>
        <button class="btn-ui-main" onclick="changeLayer(-1)">Subir Andar (‚ñ≤)</button>
        <button class="btn-ui-main" onclick="changeLayer(1)">Descer Andar (‚ñº)</button>
    </div>

    <div class="panel right">
        <small>Z-AXIS</small><br>
        <div style="font-size:24px; color:#0f0;" id="layerDisplay">7</div>
    </div>

    <div id="viewport"><div id="world"></div></div>

    <script>
        const world = document.getElementById('world');
        const viewport = document.getElementById('viewport');
        const TILE_W = 1078, TILE_H = 790;
        const PASTA_MAPA = "mapcontainer"; // Conex√£o direta com sua pasta

        let scale = 0.15, posX = window.innerWidth/2, posY = window.innerHeight/2;
        let currentZ = 7, isGridVisible = true, isEditMode = false;
        let mapData = { correcoes: [], entidades: [] };
        const slotsCriados = new Set();

        window.onload = async () => {
            await carregarDadosGitHub();
            reloadMap();
        };

        async function carregarDadosGitHub() {
            try {
                const r = await fetch(`${PASTA_MAPA}/map_data.json`);
                if(r.ok) mapData = await r.json();
            } catch(e) { console.error("Erro ao carregar JSON", e); }
        }

        function reloadMap() { 
            slotsCriados.clear(); 
            world.innerHTML = ''; 
            atualizarGradeInfinita(); 
            update(); 
        }

        function atualizarGradeInfinita() {
            const cX = Math.round(((-posX + window.innerWidth/2)/scale)/TILE_W);
            const cY = Math.round(((-posY + window.innerHeight/2)/scale)/TILE_H);
            for(let x = cX - 2; x <= cX + 2; x++) 
                for(let y = cY - 2; y <= cY + 2; y++) criarSlot(x, y);
        }

        function criarSlot(x, y) {
            const id = `${x}_${y}_${currentZ}`;
            if (slotsCriados.has(id)) return;
            slotsCriados.add(id);

            const div = document.createElement('div');
            div.className = 'slot'; 
            div.style.left = `${x * TILE_W}px`; 
            div.style.top = `${y * TILE_H}px`;
            
            const imgPath = `${PASTA_MAPA}/${id}.png`;
            div.innerHTML = `
                <div class="grid-overlay">${'<div></div>'.repeat(165)}</div>
                <img class="map-base" src="${imgPath}" onerror="this.style.display='none'">
            `;
            
            world.appendChild(div);
            renderizarConteudo(id, div);
        }

        function renderizarConteudo(slotId, divPai) {
            // Corre√ß√µes
            mapData.correcoes.filter(c => c.slotId === slotId && c.z === currentZ).forEach(data => {
                const img = document.createElement('img');
                img.src = `${PASTA_MAPA}/${data.arquivo}`;
                img.className = 'grid-livre' + (data.locked ? ' is-locked' : '');
                img.style.cssText = `left:${data.x}px; top:${data.y}px; width:${data.w}px; height:${data.h}px;`;
                divPai.appendChild(img);
            });

            // Entidades
            mapData.entidades.filter(e => e.slotId === slotId && e.z === currentZ).forEach(data => {
                const wrap = document.createElement('div'); 
                wrap.className = `entidade-wrap type-${data.tipo || 'npc'}`;
                wrap.style.cssText = `left:${data.x}px; top:${data.y}px; width:${data.w}px; height:${data.h}px;`;
                
                const img = document.createElement('img');
                img.src = `${PASTA_MAPA}/${data.arquivo}`;
                img.className = 'entidade-img';
                
                wrap.appendChild(img);
                divPai.appendChild(wrap);
            });
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btnEdit');
            if(isEditMode) {
                document.body.classList.replace('edit-mode-off', 'edit-mode-active');
                btn.innerText = "Modo Edi√ß√£o: ON";
                btn.style.background = "#0f0";
                btn.style.color = "#000";
            } else {
                document.body.classList.replace('edit-mode-active', 'edit-mode-off');
                btn.innerText = "Modo Edi√ß√£o: OFF";
                btn.style.background = "#222";
                btn.style.color = "#fff";
            }
        }

        function changeLayer(v) {
            currentZ = Math.max(0, Math.min(15, currentZ + v));
            document.getElementById('layerDisplay').innerText = currentZ;
            reloadMap();
        }

        function toggleGrid() {
            isGridVisible = !isGridVisible;
            world.classList.toggle('grid-hidden', !isGridVisible);
        }

        function baixarJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(mapData, null, 2));
            const dl = document.createElement('a');
            dl.href = dataStr; dl.download = "map_data.json"; dl.click();
        }

        // C√¢mera
        let drag = false, sx, sy;
        viewport.onmousedown = (e) => { drag = true; sx = e.clientX - posX; sy = e.clientY - posY; };
        window.onmousemove = (e) => { if(drag) { posX = e.clientX - sx; posY = e.clientY - sy; update(); atualizarGradeInfinita(); }};
        window.onmouseup = () => drag = false;
        viewport.onwheel = (e) => {
            e.preventDefault();
            const wx = (e.clientX - posX) / scale;
            const wy = (e.clientY - posY) / scale;
            scale *= e.deltaY < 0 ? 1.1 : 0.9;
            posX = e.clientX - wx * scale;
            posY = e.clientY - wy * scale;
            update(); atualizarGradeInfinita();
        };
        function update() { world.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`; }
    </script>
</body>
</html>