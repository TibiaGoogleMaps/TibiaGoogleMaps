<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Tibia Map Viewer - Visitor Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        #viewport { width: 100vw; height: 100vh; cursor: grab; position: relative; }
        #world { position: absolute; transform-origin: 0 0; }
        
        .slot { position: absolute; width: 1078px; height: 790px; border: none; display: flex; align-items: center; justify-content: center; }
        
        /* Grade visual (opcional para visitantes, deixei mais sutil) */
        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(11, 1fr);
            pointer-events: none; z-index: 2; opacity: 0.3;
        }
        .grid-overlay div { border: 0.5px solid rgba(255, 255, 255, 0.1); } 
        .grid-hidden .grid-overlay { display: none; }

        .map-base { width: 100%; height: 100%; position: absolute; z-index: 1; image-rendering: pixelated; pointer-events: none; }
        
        /* Esconder elementos de edi√ß√£o */
        .btn-central, .controles-npc, .ui-top-bar, .handle-move-text { display: none !important; }
        
        .entidade-wrap { position: absolute; z-index: 60; pointer-events: none; } /* Visitante n√£o clica/arrasta */
        .entidade-img { width: 100%; height: 100%; display: block; image-rendering: pixelated; }
        
        /* FILTROS DE VISIBILIDADE */
        .hide-npc .type-npc, .hide-item .type-item, .hide-mob .type-mob, .hide-balao .type-balao { display: none !important; }

        #search-container { position: fixed; top: 15px; right: 15px; width: 250px; z-index: 2000; }
        #map-search { width: 100%; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #444; color: #fff; border-radius: 4px; outline: none; }
        #search-results { background: rgba(20,20,20,0.95); border: 1px solid #444; border-top: none; max-height: 300px; overflow-y: auto; border-radius: 0 0 4px 4px; }
        
        #filter-box { margin-top: 10px; background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 10px; border-radius: 4px; font-size: 12px; }
        .filter-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; cursor: pointer; }

        /* Interfaces (Bal√µes de fala, etc) */
        .interface-container { position: absolute; z-index: 200; pointer-events: none; }
        .interface-img { width: 100%; height: 100%; display: block; image-rendering: pixelated; }
        .ui-texto { color: #fff; font-size: 14px; text-shadow: 1px 1px 0px #000; white-space: pre-wrap; width: 100%; height: 100%; position: absolute; }
        .ui-scroll-area { position: absolute; overflow: visible; }

        .panel { position: fixed; background: rgba(0,0,0,0.9); padding: 12px; border-radius: 8px; border: 1px solid #333; z-index: 1000; }
        .left { top: 15px; left: 15px; width: 220px; }
        .right { top: 50%; right: 20px; transform: translateY(-50%); text-align: center; }
        .btn-ui-main { width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px; }
        .btn-ui-main:hover { background: #444; }
    </style>
</head>
<body>

    <div id="search-container">
        <input type="text" id="map-search" placeholder="üîç Buscar Local..." oninput="buscarTags()">
        <div id="search-results"></div>
        <div id="filter-box">
            <strong>Visualiza√ß√£o</strong><br><br>
            <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('npc', this.checked)"> NPCs</label>
            <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('item', this.checked)"> Itens</label>
            <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('mob', this.checked)"> Monstros</label>
            <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('balao', this.checked)"> Bal√µes</label>
        </div>
    </div>

    <div class="panel left">
        <strong>Tibia Viewer</strong><br>
        <small style="color:#888;">Modo Visitante</small><br><br>
        
        <button class="btn-ui-main" onclick="toggleGrid()">Grade: ON/OFF</button>
        <div id="status" style="font-size:11px; color: #0f0; margin-top: 10px;">Mapa Carregado</div>
    </div>

    <div class="panel right">
        <small>ANDAR (Z)</small><br>
        <button class="btn-ui-main" onclick="changeLayer(-1)">‚ñ≤</button>
        <div style="font-size:24px; color:#0f0;" id="layerDisplay">7</div>
        <button class="btn-ui-main" onclick="changeLayer(1)">‚ñº</button>
    </div>

    <div id="viewport"><div id="world"></div></div>

    <script>
        const world = document.getElementById('world');
        const viewport = document.getElementById('viewport');
        const TILE_W = 1078, TILE_H = 790;
        
        // Configura√ß√£o de Caminho para GitHub/Hospedagem
        const BASE_PATH = './mapcontainer/'; 
        
        let scale = 0.15, posX = window.innerWidth/2, posY = window.innerHeight/2;
        let currentZ = 7, isGridVisible = true;
        let mapData = { correcoes: [], entidades: [] };
        const slotsCriados = new Set();

        // --- INICIALIZA√á√ÉO AUTOM√ÅTICA ---
        window.onload = async () => {
            await carregarDados();
            reloadMap();
        };

        // --- SISTEMA DE CARREGAMENTO (Modificado para Fetch/HTTP) ---
        async function carregarDados() {
            try { 
                // Tenta buscar o JSON na pasta mapcontainer
                const response = await fetch(BASE_PATH + 'map_data.json');
                if (!response.ok) throw new Error("JSON n√£o encontrado");
                mapData = await response.json();
                console.log("Dados do mapa carregados:", mapData);
            } catch(e) { 
                console.warn("map_data.json n√£o encontrado ou erro de leitura. Iniciando vazio.", e);
                mapData = { correcoes: [], entidades: [] }; 
            }
        }

        // --- UTILIT√ÅRIOS ---
        function toggleVisibility(tipo, isVisible) { world.classList.toggle('hide-' + tipo, !isVisible); }

        function buscarTags() {
            const termo = document.getElementById('map-search').value.toLowerCase();
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '';
            if(!termo) return;
            const lista = [...mapData.entidades, ...mapData.correcoes].filter(obj => obj.tag && obj.tag.toLowerCase().includes(termo));
            lista.forEach(obj => {
                const div = document.createElement('div');
                div.style.padding = '8px'; div.style.cursor = 'pointer'; div.style.borderBottom = '1px solid #333';
                div.innerText = `[Z${obj.z}] ${obj.tag}`;
                div.onclick = () => {
                    currentZ = obj.z; document.getElementById('layerDisplay').innerText = currentZ;
                    const [sx, sy] = obj.slotId.split('_').map(Number);
                    const rX = (sx * TILE_W) + obj.x; const rY = (sy * TILE_H) + obj.y;
                    posX = (window.innerWidth/2) - (rX * scale); posY = (window.innerHeight/2) - (rY * scale);
                    reloadMap();
                };
                resDiv.appendChild(div);
            });
        }

        // --- RENDERIZA√á√ÉO DE UI E TEXTOS (Apenas Visualiza√ß√£o) ---
        function renderizarInterface(parent, entData, uiData) {
            const container = document.createElement('div');
            container.className = 'interface-container';
            container.style.cssText = `left:${uiData.x}px; top:${uiData.y}px; width:${uiData.w}px; height:${uiData.h}px;`;

            const img = document.createElement('img');
            img.className = 'interface-img';
            img.src = BASE_PATH + uiData.arquivo;
            img.onerror = () => { img.style.display = 'none'; }; // Esconde se n√£o achar
            container.appendChild(img);

            if(uiData.texts) {
                uiData.texts.forEach((t) => {
                    const area = document.createElement('div');
                    area.className = 'ui-scroll-area';
                    area.style.cssText = `left:${t.x}px; top:${t.y}px; width:${t.w}px; height:${t.h}px;`;
                    
                    const txt = document.createElement('div');
                    txt.className = 'ui-texto'; 
                    txt.innerHTML = t.content; 
                    
                    area.appendChild(txt); container.appendChild(area);
                });
            }
            parent.appendChild(container);
        }

        // --- CORE DO VISUALIZADOR ---
        function carregarConteudoSlot(slotId, slotElement) {
            // Renderizar Corre√ß√µes (Fixes)
            mapData.correcoes.filter(c => c.slotId === slotId && c.z === currentZ).forEach(data => {
                const img = document.createElement('img');
                img.src = BASE_PATH + data.arquivo;
                img.className = 'grid-livre';
                img.style.cssText = `left:${data.x}px; top:${data.y}px; width:${data.w}px; height:${data.h}px; position: absolute; pointer-events: none;`;
                img.onerror = () => { img.style.display = 'none'; };
                slotElement.appendChild(img);
            });

            // Renderizar Entidades (NPCs, Mobs, etc)
            mapData.entidades.filter(e => e.slotId === slotId && e.z === currentZ).forEach(data => {
                const wrap = document.createElement('div'); 
                wrap.className = `entidade-wrap type-${data.tipo || 'npc'}`;
                wrap.style.cssText = `left:${data.x}px; top:${data.y}px; width:${data.w}px; height:${data.h}px;`;
                
                const img = document.createElement('img');
                img.src = BASE_PATH + data.arquivo;
                img.className = 'entidade-img';
                img.onerror = () => { wrap.style.display = 'none'; };
                
                wrap.appendChild(img);
                if(data.interfaces) data.interfaces.forEach((ui) => renderizarInterface(wrap, data, ui));
                slotElement.appendChild(wrap);
            });
        }

        // --- CONTROLE DE TELA E GRADES ---
        function atualizarGradeInfinita() {
            const cX = Math.round(((-posX + window.innerWidth/2)/scale)/TILE_W);
            const cY = Math.round(((-posY + window.innerHeight/2)/scale)/TILE_H);
            // Carrega slots ao redor
            for(let x = cX - 2; x <= cX + 2; x++) for(let y = cY - 2; y <= cY + 2; y++) criarSlot(x, y);
        }

        function criarSlot(x, y) {
            const id = `${x}_${y}_${currentZ}`;
            if (slotsCriados.has(id)) return;
            slotsCriados.add(id);
            
            const div = document.createElement('div');
            div.className = 'slot'; 
            div.style.left = `${x * TILE_W}px`; 
            div.style.top = `${y * TILE_H}px`;
            
            // Grid Overlay apenas visual
            div.innerHTML = `<div class="grid-overlay">${'<div></div>'.repeat(165)}</div><img class="map-base" alt="">`;
            
            // Carregamento da Imagem do Mapa Base via URL
            const img = div.querySelector('.map-base');
            img.src = `${BASE_PATH}${id}.png`;
            img.onerror = () => { 
                img.style.display = 'none'; // Se a imagem do mapa n√£o existir, esconde (fica preto)
                // Opcional: Mostrar aviso de "Sem Mapa"
            };
            
            world.appendChild(div);
            carregarConteudoSlot(id, div);
        }

        function reloadMap() { 
            slotsCriados.clear(); 
            world.innerHTML = ''; 
            atualizarGradeInfinita(); 
            update(); 
        }
        
        function toggleGrid() { isGridVisible = !isGridVisible; world.classList.toggle('grid-hidden', !isGridVisible); }
        function changeLayer(v) { 
            currentZ = Math.max(0, Math.min(15, currentZ + v)); 
            document.getElementById('layerDisplay').innerText = currentZ; 
            reloadMap(); 
        }

        // --- INTERA√á√ÉO (Mouse Drag & Zoom) ---
        let dragM = false, sxM, syM;
        viewport.onmousedown = (e) => { 
            if(e.button === 0) { // Apenas bot√£o esquerdo
                dragM = true; sxM = e.clientX - posX; syM = e.clientY - posY; 
            }
        };
        window.onmousemove = (e) => { 
            if(dragM) { 
                posX = e.clientX - sxM; posY = e.clientY - syM; 
                update(); 
                atualizarGradeInfinita(); 
            }
        };
        window.onmouseup = () => dragM = false;
        
        viewport.onwheel = (e) => { 
            e.preventDefault(); 
            const wx = (e.clientX - posX) / scale; const wy = (e.clientY - posY) / scale;
            scale *= e.deltaY < 0 ? 1.1 : 0.9;
            // Limites de Zoom
            scale = Math.min(Math.max(0.05, scale), 2);
            posX = e.clientX - wx * scale; posY = e.clientY - wy * scale;
            update(); atualizarGradeInfinita(); 
        };
        
        function update() { world.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`; }
        update();
    </script>
</body>
</html>