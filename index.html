<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Tibia Map Editor - Restored</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
        #viewport { width: 100vw; height: 100vh; cursor: grab; position: relative; }
        #world { position: absolute; transform-origin: 0 0; }
        
    .slot { position: absolute; width: 1078px; height: 790px; border: 1px solid #1a1a1a; background: #0a0a0a; display: flex; align-items: center; justify-content: center; }
    .view-mode .slot { border: none; background: transparent; }

    .grid-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(11, 1fr);
        pointer-events: none; z-index: 2;
    }
    
    /* Estilos de Cores do Grid */
    .grid-overlay div { border: 0.5px solid rgba(255, 255, 255, 0.05); } 
    .grid-green .grid-overlay div { border: 0.5px solid rgba(0, 255, 0, 0.4); }
    .grid-red .grid-overlay div { border: 0.5px solid rgba(255, 0, 0, 0.4); }
    
    .grid-hidden .grid-overlay { display: none; }

    .map-base { width: 100%; height: 100%; position: absolute; z-index: 1; image-rendering: pixelated; pointer-events: none; }
    
    .grid-livre { position: absolute; z-index: 50; image-rendering: pixelated; user-select: none; cursor: move; border: 1px solid transparent; }
    .grid-livre.is-locked { cursor: default; pointer-events: none; }
    
    .entidade-wrap { position: absolute; z-index: 60; }
    .entidade-img { width: 100%; height: 100%; display: block; image-rendering: pixelated; cursor: pointer; }
    
    /* FILTROS DE VISIBILIDADE */
    .hide-npc .type-npc, 
    .hide-item .type-item, 
    .hide-mob .type-mob,
    .hide-balao .type-balao { display: none !important; }

    #search-container { position: fixed; top: 15px; right: 15px; width: 250px; z-index: 2000; }
    #map-search { width: 100%; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #444; color: #fff; border-radius: 4px; outline: none; }
    #search-results { background: rgba(20,20,20,0.95); border: 1px solid #444; border-top: none; max-height: 300px; overflow-y: auto; border-radius: 0 0 4px 4px; }
    
    #filter-box { margin-top: 10px; background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 10px; border-radius: 4px; font-size: 12px; }
    .filter-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; cursor: pointer; }
    .filter-item input { cursor: pointer; }

    .search-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; font-size: 12px; }
    .search-item:hover { background: #00e1ff; color: #000; }

    .interface-container { position: absolute; z-index: 200; display: none; pointer-events: auto; }
    .interface-container.ativo { display: block; }
    .interface-img { width: 100%; height: 100%; display: block; image-rendering: pixelated; pointer-events: none; }

    .ui-scroll-area { position: absolute; overflow: visible; background: rgba(255,255,255,0.05); }
    .ui-texto { color: #fff; font-size: 14px; text-shadow: 1px 1px 0px #000; white-space: pre-wrap; outline: none; width: 100%; min-height: 20px; overflow-y: auto; height: 100%; }

    .panel { position: fixed; background: rgba(0,0,0,0.9); padding: 12px; border-radius: 8px; border: 1px solid #333; z-index: 1000; }
    .left { top: 15px; left: 15px; width: 220px; }
    .right { top: 50%; right: 20px; transform: translateY(-50%); text-align: center; }
    .btn-ui-main { width: 100%; padding: 8px; margin: 4px 0; cursor: pointer; background: #333; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px; }
</style></head>
<body>

<div id="search-container">
    <input type="text" id="map-search" placeholder=" Buscar Tag ou Nome..." oninput="buscarTags()">
    <div id="search-results"></div>
    
    <div id="filter-box">
        <div style="margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:4px;"><strong>Visualização</strong></div>
        <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('npc', this.checked)"> NPCs</label>
        <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('item', this.checked)"> Itens</label>
        <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('mob', this.checked)"> Monstros</label>
        <label class="filter-item"><input type="checkbox" checked onchange="toggleVisibility('balao', this.checked)"> Balões</label>
    </div>
</div>

<div class="panel left">
    <strong>Tibia Editor Pro</strong>
    <button class="btn-ui-main" onclick="toggleGrid()">Grade: ON/OFF</button>
    <button class="btn-ui-main" onclick="toggleGridColor()" id="btnGridColor" style="color: #0f0;">Cor do Grid: Original</button>
    <div id="status" style="font-size:11px; color: #888;">Online</div>
</div>

<div class="panel right">
    <small>Z-AXIS</small>

    <button class="btn-ui-main" onclick="changeLayer(-1)">▲</button>
    <div style="font-size:24px; color:#0f0;" id="layerDisplay">7</div>
    <button class="btn-ui-main" onclick="changeLayer(1)">▼</button>
</div>

<div id="viewport"><div id="world"></div></div>

<script>
    const world = document.getElementById('world');
    const viewport = document.getElementById('viewport');
    const TILE_W = 1078, TILE_H = 790;
    const basePath = 'mapcontainer/';
    let scale = 0.15, posX = window.innerWidth/2, posY = window.innerHeight/2;
    let currentZ = 7, isGridVisible = true, isEditMode = false;
    let gridColorMode = 0; 
    let mapData = { correcoes: [], entidades: [] };
    const slotsCriados = new Set();

    function toggleGridColor() {
        gridColorMode = (gridColorMode + 1) % 3;
        const btn = document.getElementById('btnGridColor');
        world.classList.remove('grid-green', 'grid-red');
        if (gridColorMode === 0) {
            btn.innerText = "Cor do Grid: Original"; btn.style.color = "#fff";
        } else if (gridColorMode === 1) {
            world.classList.add('grid-green'); btn.innerText = "Cor do Grid: Verde"; btn.style.color = "#0f0";
        } else if (gridColorMode === 2) {
            world.classList.add('grid-red'); btn.innerText = "Cor do Grid: Vermelho"; btn.style.color = "#f44";
        }
    }

    function toggleVisibility(tipo, isVisible) {
        world.classList.toggle('hide-' + tipo, !isVisible);
    }

    function buscarTags() {
        const termo = document.getElementById('map-search').value.toLowerCase();
        const resDiv = document.getElementById('search-results');
        resDiv.innerHTML = '';
        if(!termo) return;
        const lista = [...mapData.entidades, ...mapData.correcoes].filter(obj => obj.tag && obj.tag.toLowerCase().includes(termo));
        lista.forEach(obj => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerText = `[Z${obj.z}] ${obj.tag}`;
            div.onclick = () => {
                currentZ = obj.z; document.getElementById('layerDisplay').innerText = currentZ;
                const [sx, sy] = obj.slotId.split('_').map(Number);
                const realX = (sx * TILE_W) + obj.x; const realY = (sy * TILE_H) + obj.y;
                posX = (window.innerWidth / 2) - (realX * scale); posY = (window.innerHeight / 2) - (realY * scale);
                reloadMap(); resDiv.innerHTML = ''; document.getElementById('map-search').value = '';
            };
            resDiv.appendChild(div);
        });
    }

    function renderizarInterface(parent, entData, uiData, uiIndex) {
        const container = document.createElement('div');
        container.className = 'interface-container';
        container.style.cssText = `left:${uiData.x}px; top:${uiData.y}px; width:${uiData.w}px; height:${uiData.h}px;`;

        const img = document.createElement('img');
        img.className = 'interface-img';
        img.src = basePath + uiData.arquivo;
        container.appendChild(img);

        if(uiData.texts) {
            uiData.texts.forEach((t) => {
                const area = document.createElement('div');
                area.className = 'ui-scroll-area';
                area.style.cssText = `left:${t.x}px; top:${t.y}px; width:${t.w}px; height:${t.h}px;`;
                
                const txt = document.createElement('div');
                txt.className = 'ui-texto'; txt.innerHTML = t.content;
                area.appendChild(txt); container.appendChild(area);
            });
        }

        parent.appendChild(container);
    }

    function carregarCorrecoesDoSlot(slotId, slotElement) {
        mapData.correcoes.filter(c => c.slotId === slotId && c.z === currentZ).forEach(data => {
            const img = document.createElement('img');
            img.src = basePath + data.arquivo; 
            img.className = 'grid-livre' + (data.locked ? ' is-locked' : '');
            img.style.cssText = `left:${data.x}px; top:${data.y}px; width:${data.w}px; height:${data.h}px;`;
            slotElement.appendChild(img);
        });

        mapData.entidades.filter(e => e.slotId === slotId && e.z === currentZ).forEach(data => {
            const wrap = document.createElement('div'); 
            wrap.className = `entidade-wrap type-${data.tipo || 'npc'}`;
            wrap.style.cssText = `left:${data.x}px; top:${data.y}px; width:${data.w}px; height:${data.h}px;`;
            const img = document.createElement('img');
            img.src = basePath + data.arquivo; img.className = 'entidade-img';
            wrap.appendChild(img);
            img.onclick = () => wrap.querySelectorAll('.interface-container').forEach(ui => ui.classList.toggle('ativo'));
            if(data.interfaces) data.interfaces.forEach((ui, idx) => renderizarInterface(wrap, data, ui, idx));
            slotElement.appendChild(wrap);
        });
    }

    async function carregarDados() {
        try {
            const res = await fetch(basePath + 'map_data.json');
            if (!res.ok) throw new Error();
            mapData = await res.json();
        } catch(e) {
            mapData = { correcoes: [], entidades: [] };
        }
    }

    function atualizarGradeInfinita() {
        const cX = Math.round(((-posX + window.innerWidth/2)/scale)/TILE_W);
        const cY = Math.round(((-posY + window.innerHeight/2)/scale)/TILE_H);
        for(let x = cX - 2; x <= cX + 2; x++) for(let y = cY - 2; y <= cY + 2; y++) criarSlot(x, y);
    }

    function criarSlot(x, y) {
        const id = `${x}_${y}_${currentZ}`;
        if (slotsCriados.has(id)) return;
        slotsCriados.add(id);
        const div = document.createElement('div');
        div.className = 'slot'; div.style.left = `${x * TILE_W}px`; div.style.top = `${y * TILE_H}px`;
        div.innerHTML = `<div class="grid-overlay">${'<div></div>'.repeat(165)}</div><img class="map-base" style="display:none">`;
        world.appendChild(div);
        const img = div.querySelector('.map-base');
        img.src = basePath + `${id}.png`;
        img.onload = () => { img.style.display = 'block'; };
        img.onerror = () => { img.style.display = 'none'; };
        carregarCorrecoesDoSlot(id, div);
    }

    function reloadMap() { slotsCriados.clear(); world.innerHTML = ''; atualizarGradeInfinita(); update(); }
    function toggleGrid() { isGridVisible = !isGridVisible; world.classList.toggle('grid-hidden', !isGridVisible); }
    function changeLayer(v) { currentZ = Math.max(0, Math.min(15, currentZ + v)); document.getElementById('layerDisplay').innerText = currentZ; reloadMap(); }
    
    let dragM = false, sxM, syM;
    viewport.onmousedown = (e) => { if(e.target === viewport || e.target.className.includes('slot')) { dragM = true; sxM = e.clientX - posX; syM = e.clientY - posY; }};
    window.onmousemove = (e) => { if(dragM) { posX = e.clientX - sxM; posY = e.clientY - syM; update(); atualizarGradeInfinita(); }};
    window.onmouseup = () => dragM = false;
    viewport.onwheel = (e) => { e.preventDefault(); const wx = (e.clientX - posX) / scale; const wy = (e.clientY - posY) / scale; scale *= e.deltaY < 0 ? 1.1 : 0.9; posX = e.clientX - wx * scale; posY = e.clientY - wy * scale; update(); atualizarGradeInfinita(); };
    function update() { world.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`; }
    world.classList.add('view-mode');
    update(); 
    carregarDados().then(reloadMap);
</script></body>
</html>

